services:
    # 1. Main Bagisto Application
    app:
        build:
            context:.
            dockerfile: Dockerfile
        environment:
            - APP_ENV=production
            - APP_DEBUG=false
            - DB_CONNECTION=mysql
            - DB_HOST=mysql
            - DB_PORT=3306
            - DB_DATABASE=${DB_DATABASE}
            - DB_USERNAME=${DB_USERNAME}
            - DB_PASSWORD=${DB_PASSWORD}
            - REDIS_HOST=redis
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        networks:
            - bagisto-network
        depends_on:
            - mysql
            - redis
            - elasticsearch

    # 2. MySQL Database
    mysql:
        image: 'mysql/mysql-server:8.0'
        environment:
            - MYSQL_ROOT_PASSWORD=${DB_PASSWORD}
            - MYSQL_DATABASE=${DB_DATABASE}
            - MYSQL_USER=${DB_USERNAME}
            - MYSQL_PASSWORD=${DB_PASSWORD}
        volumes:
            - 'bagisto-mysql:/var/lib/mysql'
        networks:
            - bagisto-network
        healthcheck:
            test:
            retries: 3
            timeout: 5s

    # 3. Redis (Cache & Queue)
    redis:
        image: 'redis:alpine'
        volumes:
            - 'bagisto-redis:/data'
        networks:
            - bagisto-network

    # 4. Elasticsearch (Optimized for Production RAM)
    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
        environment:
            - xpack.security.enabled=false
            - discovery.type=single-node
            - bootstrap.memory_lock=true
            - "ES_JAVA_OPTS=-Xms512m -Xmx512m" # Limits RAM usage to avoid VPS crashes
        ulimits:
            memlock:
                soft: -1
                hard: -1
        volumes:
            - 'bagisto-elasticsearch:/var/lib/elasticsearch/data'
        networks:
            - bagisto-network

networks:
    bagisto-network:
        driver: bridge

volumes:
    bagisto-mysql:
    bagisto-redis:
    bagisto-elasticsearch:
